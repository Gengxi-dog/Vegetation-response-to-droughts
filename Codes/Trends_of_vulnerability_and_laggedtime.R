library(tidyverse)
library(ggplot2)
library(raster)

rate_trend <- raster('Data/SM_kNDVI_vulner_summer_trend.tif')
rate_trend_pvalue <- raster('Data/SM_kNDVI_vulner_summer_trend_pvalue.tif')
rate_trend[rate_trend_pvalue > 0.05] <- NA
rate_pvalue <- raster("Data/SM_kNDVI_pvalue_summer_max.tif")

rate_trend[rate_pvalue > 0.01] <- NA

rate_trend_data <- raster::as.data.frame(rate_trend, xy = T)
names(rate_trend_data) <- c('x','y','layer')

wm_ggplot <- map_data("world")
wm_ggplot <- dplyr::filter(wm_ggplot, lat > 30)
x_lines <- seq(-120,180, by = 60)

ggplot_spatial <- function(data_set1, lowcolor = '#004c99', highcolor = '#990000', midcolor = 'white', midpoint1 = 0){
  ggplot() +
    geom_polygon(data = wm_ggplot, aes(x = long, y = lat, group = group), fill = "white", colour = "black") +
    geom_tile(data = data_set1, mapping = aes(x = x,y = y,fill = layer), alpha = 0.8) +
    scale_fill_gradient2(low = lowcolor, high = highcolor, mid = midcolor, midpoint = midpoint1, na.value = NA) +
    # geom_point(data= data_set2, mapping = aes(x=x,y=y,color=layer), size=0.005, show.legend = F) + scale_color_continuous(low = "black", high = "black", na.value=NA) +
    
    # Convert to polar coordinates
    coord_map("ortho", orientation = c(90, 0, 0)) +
    scale_y_continuous(breaks = seq(30, 90, by = 10), labels = NULL) +
    
    # Removes Axes and labels
    scale_x_continuous(breaks = NULL) +
    xlab("") + 
    ylab("") +
    
    # Adds labels
    # geom_text(aes(x = 180, y = seq(30, 90, by = 10), hjust = -0.2, label = paste0(seq(30, 90, by = 10), "??N"))) +
    # geom_text(aes(x = x_lines, y = 30, label = c("120??W", "60??W", "0??", "60??E", "120??E", "180??W"))) +
    
    # Adds axes
    geom_hline(aes(yintercept = 30), size = 0.5)  +
    geom_segment(aes(y = 30, yend = 90, x = x_lines, xend = x_lines), linetype = "dashed", color = 'grey50') +
    
    # Change theme to remove axes and ticks
    theme(panel.background = element_blank(),
          panel.grid.major = element_line(size = 0.5, linetype = 'dashed', colour = "grey50"), axis.ticks=element_blank())+
    theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(1, 'cm'), legend.key.width = unit(0.5,'cm'), legend.text = element_text(size = 20))
}

rate_spqtial_trend <- ggplot_spatial(data_set1 = rate_trend_data) 

lag_trend <- raster('Data/SM_kNDVI_lag_summer_trend.tif')
lag_trend_pvalue <- raster('Data/SM_kNDVI_lag_summer_trend_pvalue.tif')
lag_trend[lag_trend_pvalue > 0.05] <- NA
lag_pvalue <- raster("Data/SM_kNDVI_pvalue_summer_max.tif")

lag_trend[rate_pvalue > 0.01] <- NA

lag_trend_data <- raster::as.data.frame(lag_trend, xy = T)
names(lag_trend_data) <- c('x','y','layer')

lag_spqtial_trend <- ggplot_spatial(data_set1 = lag_trend_data, highcolor = '#004c99', lowcolor = '#990000', midcolor = 'white', midpoint1 = 0) 

sum(rate_trend_data$layer > 0, na.rm = T)/sum(!is.na(rate_trend_data$layer))
sum(rate_trend_data$layer < 0, na.rm = T)/sum(!is.na(rate_trend_data$layer))

sum(lag_trend_data$layer > 0, na.rm = T)/sum(!is.na(lag_trend_data$layer))
sum(lag_trend_data$layer < 0, na.rm = T)/sum(!is.na(lag_trend_data$layer))

rate_1987_2017 <- brick('Data/SM_kNDVI_vulner_summer_1987_2017.nc')
rate_1987_2017[rate_trend_pvalue > 0.05] <- NA
rate_1987_2017[rate_pvalue > 0.01] <- NA
rate_1987_2017_arr <- as.array(rate_1987_2017)

rate_mean_trend <- apply(rate_1987_2017_arr, FUN = mean, MARGIN = 3, na.rm = T)
rate_mean_trend_plot <- as.data.frame(cbind(c(1987:2017), rate_mean_trend))
names(rate_mean_trend_plot) <- c('year', 'rate')

rate_mean_trend_plot_1993_2013 <- rate_mean_trend_plot[7:27,]
#--------------------------------------------
rate_line_trend <- ggplot() +
  geom_point(data = rate_mean_trend_plot, mapping = aes(x=year, y=rate)) +
  geom_smooth(data = rate_mean_trend_plot, aes(x=year, y=rate), method='loess', se=T) +
  geom_smooth(data = rate_mean_trend_plot_1993_2013, aes(x=year, y=rate), method=lm, color = 'black', se=F) + 
  scale_x_continuous(limits = c(1987,2017), breaks = c(1990,1995,2000,2005,2010,2015), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0.2,0.6), expand = c(0.01,0.01), breaks = c(0.2,0.4,0.6)) +
  labs(x = "Year", y = 'Coincidence Rate') +
  annotate("text", label = "***", x=1990, y=0.45, size=8)+
  theme_bw() +
  theme(axis.title = element_text(colour = 'black', size = 20), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(3, 'cm'), legend.key.width = unit(1,'cm'), legend.text = element_text(size = 20))


lag_1987_2017 <- brick('Data/SM_kNDVI_lag_summer_1987_2017.nc')
lag_1987_2017[lag_trend_pvalue > 0.05] <- NA
lag_1987_2017[lag_pvalue > 0.01] <- NA
lag_1987_2017_arr <- as.array(lag_1987_2017) - 2
lag_mean_trend <- apply(lag_1987_2017_arr, FUN = mean, MARGIN = 3, na.rm = T)

lag_mean_trend_plot <- as.data.frame(cbind(c(1987:2017), lag_mean_trend))
names(lag_mean_trend_plot) <- c('year', 'lag')
lag_mean_trend_plot$lag <- lag_mean_trend_plot$lag*8

lag_mean_trend_plot_1990_2005 <- lag_mean_trend_plot[4:19,]
#--------------------------------------------
lag_line_trend <- ggplot() +
  geom_point(data = lag_mean_trend_plot, mapping = aes(x=year, y=lag)) +
  geom_smooth(data = lag_mean_trend_plot, mapping = aes(x=year, y=lag), method='loess', se=T) +
  geom_smooth(data = lag_mean_trend_plot_1990_2005, mapping = aes(x=year, y=lag), method=lm, color = 'black', se=F) +
  scale_x_continuous(limits = c(1987,2017), breaks = c(1990,1995,2000,2005,2010,2015), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(20,40), expand = c(0.01,0.01), breaks = c(20,30,40)) +
  labs(x = "Year", y = 'Coincidence Rate') +
  annotate("text", label = "***", x=1990, y=0.45, size=8)+
  theme_bw() +
  theme(axis.title = element_text(colour = 'black', size = 20), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(3, 'cm'), legend.key.width = unit(1,'cm'), legend.text = element_text(size = 20))

ggarrange(rate_spqtial_trend, lag_spqtial_trend, rate_line_trend, lag_line_trend, heights = c(2,1))
ggsave(filename = 'Data/vulber_lag_trends.pdf', device = 'pdf', width = 14, height = 12, units = c('in'))
