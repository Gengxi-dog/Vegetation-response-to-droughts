library(raster)
library(ggplot2)
library(tidyverse)

setwd('/Data/')
SM_SIF_vulner_max <- raster('SIF_SM/SM_SIF_vulner_summer_max.tif')
landuse <- raster('MCD12C1.A2015001.006.2018053185652_MOD12C1.tif')
landuse_025res <- resample(landuse, y = SM_SIF_vulner_max, method = 'ngb')
landuse_025res_data <- raster::as.data.frame(landuse_025res, xy = T)
names(landuse_025res_data) <- c('x', 'y', 'layer')

SM_SIF_vulner_data <- raster::as.data.frame(SM_SIF_vulner_max, xy = T)
names(SM_SIF_vulner_data) <- c('x','y','layer')
SM_SIF_vulner_data$layer[landuse_025res_data$layer == 0 | landuse_025res_data$layer == 11 | landuse_025res_data$layer == 13 | landuse_025res_data$layer == 15 | landuse_025res_data$layer == 16 | landuse_025res_data$layer == 17 |landuse_025res_data$layer == 255] <- NA
SM_SIF_vulner_data$layer[1] <- 1
SM_SIF_vulner_data$layer[2] <- 0

SM_SIF_lag_max <- raster('/SM_SIF_lag_summer_max.tif')
SM_SIF_lag_data <- raster::as.data.frame(SM_SIF_lag_max, xy = T)
names(SM_SIF_lag_data) <- c('x','y','layer')
SM_SIF_lag_data$layer[landuse_025res_data$layer == 0 | landuse_025res_data$layer == 11 | landuse_025res_data$layer == 13 | landuse_025res_data$layer == 15 | landuse_025res_data$layer == 16 | landuse_025res_data$layer == 17 |landuse_025res_data$layer == 255] <- NA
SM_SIF_lag_data$layer <- SM_SIF_lag_data$layer - 2
SM_SIF_lag_data$layer <- SM_SIF_lag_data$layer*8

SM_kNDVI_vulner_max <- raster('/SM_kNDVI_vulner_summer_max.tif')
SM_kNDVI_vulner_data <- raster::as.data.frame(SM_kNDVI_vulner_max, xy = T)
names(SM_kNDVI_vulner_data) <- c('x','y','layer')
SM_kNDVI_vulner_data$layer[landuse_025res_data$layer == 0 | landuse_025res_data$layer == 11 | landuse_025res_data$layer == 13 | landuse_025res_data$layer == 15 | landuse_025res_data$layer == 16 | landuse_025res_data$layer == 17 |landuse_025res_data$layer == 255] <- NA
SM_kNDVI_vulner_data$layer[1] <- 1

SM_kNDVI_lag_max <- raster('/SM_kNDVI_lag_summer_max.tif')
SM_kNDVI_lag_data <- raster::as.data.frame(SM_kNDVI_lag_max, xy = T)
names(SM_kNDVI_lag_data) <- c('x','y','layer')
SM_kNDVI_lag_data$layer[landuse_025res_data$layer == 0 | landuse_025res_data$layer == 11 | landuse_025res_data$layer == 13 | landuse_025res_data$layer == 15 | landuse_025res_data$layer == 16 | landuse_025res_data$layer == 17 |landuse_025res_data$layer == 255] <- NA
SM_kNDVI_lag_data$layer <- SM_kNDVI_lag_data$layer*8

wm_ggplot <- map_data("world")
wm_ggplot <- dplyr::filter(wm_ggplot, lat > 30)
x_lines <- seq(-120,180, by = 60)

ggplot_spatial <- function(data_set1, lowcolor = '#004c99', highcolor = '#990000', midcolor = 'white', midpoint1 = 0){
  ggplot() +
    geom_tile(data = data_set1, mapping = aes(x = x,y = y,fill = layer), alpha = 0.8) +
    scale_fill_gradient2(low = lowcolor, high = highcolor, mid = midcolor, midpoint = midpoint1, na.value = NA) +
    geom_polygon(data = wm_ggplot, aes(x = long, y = lat, group = group), fill = "white", colour = "black", alpha = 0) +
    
    # Convert to polar coordinates
    coord_map("ortho", orientation = c(90, 0, 0)) +
    scale_y_continuous(breaks = seq(30, 90, by = 10), labels = NULL) +
    
    # Removes Axes and labels
    scale_x_continuous(breaks = NULL) +
    xlab("") + 
    ylab("") +
    
    # Adds axes
    geom_hline(aes(yintercept = 30), size = 0.5)  +
    geom_segment(aes(y = 30, yend = 90, x = x_lines, xend = x_lines), linetype = "dashed", color = 'grey50') +
    
    # Change theme to remove axes and ticks
    theme(panel.background = element_blank(),
          panel.grid.major = element_line(size = 0.5, linetype = 'dashed', colour = "grey50"), axis.ticks=element_blank())+
    theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(1, 'cm'), legend.key.width = unit(0.5,'cm'), legend.text = element_text(size = 20))
}

vulner_SIF <- ggplot_spatial(data_set1 = SM_SIF_vulner_data, midcolor = '#ffffcc', midpoint1 = 0.2)
vulner_kNDVI <- ggplot_spatial(data_set1 = SM_kNDVI_vulner_data, midcolor = '#ffffcc', midpoint1 = 0.2)
lag_SIF <- ggplot_spatial(data_set1 = SM_SIF_lag_data, highcolor = '#004c99', lowcolor = '#990000', midcolor = '#ffffcc', midpoint1 = 30)
lag_kNDVI <- ggplot_spatial(data_set1 = SM_kNDVI_lag_data, highcolor = '#004c99', lowcolor = '#990000', midcolor = '#ffffcc', midpoint1 = 30)

p_vulner_lag_spatial <- ggarrange(vulner_kNDVI, lag_kNDVI, vulner_SIF, lag_SIF, legend = 'right')

# plot vulnerability and lag changes align latitude
#-----------------------------------
SM_SIF_vulner_data_lat <- matrix(SM_SIF_vulner_data$layer, nrow = 1440)
SM_SIF_vulner_lat_mean <- apply(SM_SIF_vulner_data_lat, MARGIN = 2, FUN = mean, na.rm = T)
SM_SIF_vulner_lat_sd <- apply(SM_SIF_vulner_data_lat, MARGIN = 2, FUN = sd, na.rm = T)
SM_SIF_vulner_data_lat_data <- as.data.frame(cbind(seq(90, 30, -0.25), SM_SIF_vulner_lat_mean + SM_SIF_vulner_lat_sd/2, SM_SIF_vulner_lat_mean, SM_SIF_vulner_lat_mean - SM_SIF_vulner_lat_sd/2)) 
names(SM_SIF_vulner_data_lat_data) <- c("lat","max", "mean", "min")

SM_SIF_vulner_data_lat_data1 <- dplyr::filter(SM_SIF_vulner_data_lat_data, lat < 70)

SM_kNDVI_vulner_data_lat <- matrix(SM_kNDVI_vulner_data$layer, nrow = 1440)
SM_kNDVI_vulner_lat_mean <- apply(SM_kNDVI_vulner_data_lat, MARGIN = 2, FUN = mean, na.rm = T)
SM_kNDVI_vulner_lat_sd <- apply(SM_kNDVI_vulner_data_lat, MARGIN = 2, FUN = sd, na.rm = T)
SM_kNDVI_vulner_data_lat_data <- as.data.frame(cbind(seq(90, 30, -0.25), SM_kNDVI_vulner_lat_mean + SM_kNDVI_vulner_lat_sd/2, SM_kNDVI_vulner_lat_mean, SM_kNDVI_vulner_lat_mean - SM_kNDVI_vulner_lat_sd/2)) 
names(SM_kNDVI_vulner_data_lat_data) <- c("lat","max", "mean", "min")

SM_kNDVI_vulner_data_lat_data1 <- dplyr::filter(SM_kNDVI_vulner_data_lat_data, lat < 70)

SM_SIF_kNDVI_vulner_data_lat_data1 <- cbind(rbind(SM_SIF_vulner_data_lat_data1, SM_kNDVI_vulner_data_lat_data1), rep(c('SIF', 'kNDVI'), each = 160))

names(SM_SIF_kNDVI_vulner_data_lat_data1) <- c('lat', 'max', 'mean', 'min', 'VI')

# ggplot vulner
vulner_line_lat <- ggplot(data = SM_SIF_kNDVI_vulner_data_lat_data1) + geom_ribbon(aes(x = lat, ymin = min, ymax = max, fill = VI), alpha = 0.2) + geom_line(aes(x = lat, y = mean, color = VI), linewidth = 1.5) + coord_flip() +theme_bw() + theme(legend.title = element_blank(), legend.text = element_text(colour = "black", size = 20)) +
  xlab('Latitude') +
  ylab('Coincidence Rate') +
    scale_x_continuous(limits = c(30,75), expand = c(0.01,0.01), sec.axis = sec_axis(~ ., breaks = c(30,50,70), labels = c("30??N","50??N","70??N"))) + 
    scale_y_continuous(limits = c(0.1,0.5), breaks = c(0,0.2,0.4,0.6)) +
    theme(axis.ticks.y.right = element_blank(), axis.text.y.right = element_blank()) + 
    theme(panel.grid = element_blank()) +
    theme(legend.position = "bottom") +
    theme(panel.grid = element_blank()) +
    theme(axis.text = element_text(color = "black", size = 20), axis.title = element_text(color = "black", size = 20), axis.text.y = element_text(angle = 90), axis.ticks.length = unit(0.3, "cm"),axis.ticks = element_line(size = 1)) + 
    theme(panel.border = element_rect(color = "black", size = 1))

SM_SIF_lag_data_lat <- matrix(SM_SIF_lag_data$layer, nrow = 1440)
SM_SIF_lag_lat_mean <- apply(SM_SIF_lag_data_lat, MARGIN = 2, FUN = mean, na.rm = T)
SM_SIF_lag_lat_sd <- apply(SM_SIF_lag_data_lat, MARGIN = 2, FUN = sd, na.rm = T)
SM_SIF_lag_data_lat_data <- as.data.frame(cbind(seq(90, 30, -0.25), SM_SIF_lag_lat_mean + SM_SIF_lag_lat_sd/2, SM_SIF_lag_lat_mean, SM_SIF_lag_lat_mean - SM_SIF_lag_lat_sd/2)) 
names(SM_SIF_lag_data_lat_data) <- c("lat","max", "mean", "min")

SM_SIF_lag_data_lat_data1 <- dplyr::filter(SM_SIF_lag_data_lat_data, lat < 70)

SM_kNDVI_lag_data_lat <- matrix(SM_kNDVI_lag_data$layer, nrow = 1440)
SM_kNDVI_lag_lat_mean <- apply(SM_kNDVI_lag_data_lat, MARGIN = 2, FUN = mean, na.rm = T)
SM_kNDVI_lag_lat_sd <- apply(SM_kNDVI_lag_data_lat, MARGIN = 2, FUN = sd, na.rm = T)
SM_kNDVI_lag_data_lat_data <- as.data.frame(cbind(seq(90, 30, -0.25), SM_kNDVI_lag_lat_mean + SM_kNDVI_lag_lat_sd/2, SM_kNDVI_lag_lat_mean, SM_kNDVI_lag_lat_mean - SM_kNDVI_lag_lat_sd/2)) 
names(SM_kNDVI_lag_data_lat_data) <- c("lat","max", "mean", "min")

SM_kNDVI_lag_data_lat_data1 <- dplyr::filter(SM_kNDVI_lag_data_lat_data, lat < 70)

SM_SIF_kNDVI_lag_data_lat_data1 <- cbind(rbind(SM_SIF_lag_data_lat_data1, SM_kNDVI_lag_data_lat_data1), rep(c('SIF', 'kNDVI'), each = 160))

names(SM_SIF_kNDVI_lag_data_lat_data1) <- c('lat', 'max', 'mean', 'min', 'VI')

# ggplot lag
lag_line_lat <- ggplot(data = SM_SIF_kNDVI_lag_data_lat_data1) + geom_ribbon(aes(x = lat, ymin = min, ymax = max, fill = VI), alpha = 0.2) + geom_line(aes(x = lat, y = mean, color = VI), linewidth = 1.5) + coord_flip() +theme_bw() + theme(legend.title = element_blank(), legend.text = element_text(colour = "black", size = 20)) +
  scale_x_continuous(limits = c(30,75), expand = c(0.01,0.01), sec.axis = sec_axis(~ ., breaks = c(30,50,70), labels = c("30??N","50??N","70??N"))) + 
  scale_y_continuous(limits = c(0,60), breaks = c(0,20,40,60)) +
  xlab('Latitude') +
  ylab('Lagged Day') +
  theme(axis.ticks.y.right = element_blank(), axis.text.y.right = element_blank()) + 
  theme(panel.grid = element_blank()) +
  theme(legend.position = "bottom") +
  theme(panel.grid = element_blank()) +
  theme(axis.text = element_text(color = "black", size = 20), axis.title = element_text(color = "black", size = 20), axis.text.y = element_text(angle = 90), axis.ticks.length = unit(0.3, "cm"),axis.ticks = element_line(size = 1)) + 
  theme(panel.border = element_rect(color = "black", size = 1))

# ggplot for different vegetation types
#-----------------------------------------------
SM_kNDVI_vulner_data

SM_kNDVI_vulner_evergreen_forest <- SM_kNDVI_vulner_data[which(landuse_025res_data$layer == 1 | landuse_025res_data$layer == 2),]
evergreen_sd <- sd(SM_kNDVI_vulner_evergreen_forest$layer, na.rm = T)
evergreen_mean <- mean(SM_kNDVI_vulner_evergreen_forest$layer, na.rm = T)

SM_kNDVI_vulner_deciduous_forest <- SM_kNDVI_vulner_data[which(landuse_025res_data$layer == 3 | landuse_025res_data$layer == 4),]
deciduous_sd <- sd(SM_kNDVI_vulner_deciduous_forest$layer, na.rm = T)
deciduous_mean <- mean(SM_kNDVI_vulner_deciduous_forest$layer, na.rm = T)

SM_kNDVI_vulner_shrub <- SM_kNDVI_vulner_data[which(landuse_025res_data$layer == 6 | landuse_025res_data$layer == 7),]
shrub_sd <- sd(SM_kNDVI_vulner_shrub$layer, na.rm = T)
shrub_mean <- mean(SM_kNDVI_vulner_shrub$layer, na.rm = T)

SM_kNDVI_vulner_sav <- SM_kNDVI_vulner_data[which(landuse_025res_data$layer == 8 | landuse_025res_data$layer == 9),]
sav_sd <- sd(SM_kNDVI_vulner_sav$layer, na.rm = T)
sav_mean <- mean(SM_kNDVI_vulner_sav$layer, na.rm = T)

SM_kNDVI_vulner_gra <- SM_kNDVI_vulner_data[which(landuse_025res_data$layer == 10),]
gra_sd <- sd(SM_kNDVI_vulner_gra$layer, na.rm = T)
gra_mean <- mean(SM_kNDVI_vulner_gra$layer, na.rm = T)

SM_kNDVI_vulner_lucc <- cbind(as.data.frame(cbind(c(evergreen_mean, deciduous_mean, shrub_mean, sav_mean, gra_mean), c(evergreen_sd, deciduous_sd, shrub_sd, sav_sd, gra_sd))), c('EVGR','DEDU','SHR','SAV','GRA'))
names(SM_kNDVI_vulner_lucc) <- c('vulner','sd','type')

# ggplot vulner vegetation types
p_type_kNDVI_vulner_barplot <- ggplot(data = SM_kNDVI_vulner_lucc, aes(x=type, y=vulner, fill = type)) + geom_col(width = 0.7) +
  scale_fill_manual(breaks = c('EVGR','DEDU','SAV', 'SHR', 'GRA'), values = c("#4DBBD5B2", "#00A087B2", "#3C5488B2", "#F39B7FB2", "#DC0000B2")) +
  scale_x_discrete(limits = c('EVGR','DEDU', 'SAV', 'SHR', 'GRA')) +
  geom_errorbar(aes(ymin = vulner - 0.5*sd, ymax = vulner + 0.5*sd), linewidth=1.5, width = 0.3, position=position_dodge(.9)) +
  labs(y = 'Coincidence Rate') +
  theme_bw() + 
  theme(legend.position = "none") + 
  theme(axis.title.x = element_blank(), axis.title.y = element_text(colour = 'black', size = 20), axis.text = element_text(colour = 'black', size = 20)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(axis.ticks.length = unit(0.3, "cm"), axis.ticks = element_line(linewidth = 1)) + theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) + scale_y_continuous(limits = c(0,0.6))

#-----------------------------------------------
SM_kNDVI_lag_data

SM_kNDVI_lag_evergreen_forest <- SM_kNDVI_lag_data[which(landuse_025res_data$layer == 1 | landuse_025res_data$layer == 2),]
evergreen_lag_sd <- sd(SM_kNDVI_lag_evergreen_forest$layer, na.rm = T)
evergreen_lag_mean <- mean(SM_kNDVI_lag_evergreen_forest$layer, na.rm = T)

SM_kNDVI_lag_deciduous_forest <- SM_kNDVI_lag_data[which(landuse_025res_data$layer == 3 | landuse_025res_data$layer == 4),]
deciduous_lag_sd <- sd(SM_kNDVI_lag_deciduous_forest$layer, na.rm = T)
deciduous_lag_mean <- mean(SM_kNDVI_lag_deciduous_forest$layer, na.rm = T)

SM_kNDVI_lag_shrub <- SM_kNDVI_lag_data[which(landuse_025res_data$layer == 6 | landuse_025res_data$layer == 7),]
shrub_lag_sd <- sd(SM_kNDVI_lag_shrub$layer, na.rm = T)
shrub_lag_mean <- mean(SM_kNDVI_lag_shrub$layer, na.rm = T)

SM_kNDVI_lag_sav <- SM_kNDVI_lag_data[which(landuse_025res_data$layer == 8 | landuse_025res_data$layer == 9),]
sav_lag_sd <- sd(SM_kNDVI_lag_sav$layer, na.rm = T)
sav_lag_mean <- mean(SM_kNDVI_lag_sav$layer, na.rm = T)

SM_kNDVI_lag_gra <- SM_kNDVI_lag_data[which(landuse_025res_data$layer == 10),]
gra_lag_sd <- sd(SM_kNDVI_lag_gra$layer, na.rm = T)
gra_lag_mean <- mean(SM_kNDVI_lag_gra$layer, na.rm = T)

SM_kNDVI_lag_lucc <- cbind(as.data.frame(cbind(c(evergreen_lag_mean, deciduous_lag_mean, shrub_lag_mean, sav_lag_mean, gra_lag_mean), c(evergreen_lag_sd, deciduous_lag_sd, shrub_lag_sd, sav_lag_sd, gra_lag_sd))), c('EVGR','DEDU','SHR','SAV','GRA'))
names(SM_kNDVI_lag_lucc) <- c('lag','sd','type')

# ggplot lag vegetation types
p_type_kNDVI_lag_barplot <- ggplot(data = SM_kNDVI_lag_lucc, aes(x=type, y=lag, fill = type)) + geom_col(width = 0.7) +
  scale_fill_manual(breaks = c('EVGR','DEDU','SAV', 'SHR', 'GRA'), values = c("#4DBBD5B2", "#00A087B2", "#3C5488B2", "#F39B7FB2", "#DC0000B2")) +
  scale_x_discrete(limits = c('EVGR','DEDU', 'SAV', 'SHR', 'GRA')) +
  geom_errorbar(aes(ymin = lag - 0.5*sd, ymax = lag + 0.5*sd), linewidth=1.5, width = 0.3, position=position_dodge(.9)) +
  labs(y = 'Lagged Day') +
  theme_bw() + 
  theme(legend.position = "none") + 
  theme(axis.title.x = element_blank(), axis.title.y = element_text(colour = 'black', size = 20), axis.text = element_text(colour = 'black', size = 20)) + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  theme(axis.ticks.length = unit(0.3, "cm"), axis.ticks = element_line(linewidth = 1)) + 
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) + 
  scale_y_continuous(limits = c(0,60))

# aridity
global_ai <- raster('E:/scientif_data/global-et0-ai/global-ai_et0/ai_et0/ai_et0.tif')
global_ai_NH <- resample(global_ai, y = SM_SIF_vulner_max)
global_ai_NH_data <- raster::as.data.frame(global_ai_NH$ai_et0, xy = T)
global_ai_NH_data$ai_et0[landuse_025res_data$layer == 0 | landuse_025res_data$layer == 11 | landuse_025res_data$layer == 13 | landuse_025res_data$layer == 15 | landuse_025res_data$layer == 16 | landuse_025res_data$layer == 17 |landuse_025res_data$layer == 255] <- NA
names(global_ai_NH_data) <- c('x','y','AI')

biodiversity_globle <- raster('Data/biodiversity_globe_025res.tif')
biodiversity_NH <- resample(biodiversity_globle, y = SM_SIF_vulner_max)
remove(biodiversity_globle)
biodiversity_NH_data <- raster::as.data.frame(biodiversity_NH, xy = T)
biodiversity_NH_data$biodiversity_globe_025res[landuse_025res_data$layer == 0 | landuse_025res_data$layer == 11 | landuse_025res_data$layer == 13 | landuse_025res_data$layer == 15 | landuse_025res_data$layer == 16 | landuse_025res_data$layer == 17 |landuse_025res_data$layer == 255] <- NA
names(biodiversity_NH_data) <- c('x','y','biod')

vulner_lag_AI_biod <- as.data.frame(cbind(kNDVI_monthly_NH_mean_data$y, kNDVI_monthly_NH_mean_data$kNDVI, global_ai_NH_data$AI, SM_kNDVI_vulner_data$layer, SM_SIF_lag_data$layer, SM_kNDVI_pvalue_data$layer, biodiversity_NH_data$biod))
names(vulner_lag_AI_biod) <- c('lat', 'kNDVI', 'AI', 'vulner', 'lag', 'pvalue', 'biod')
vulner_lag_AI_biod <- dplyr::filter(vulner_lag_AI_biod, pvalue < 0.01)

vulner_lag_AI_biod1 <- dplyr::filter(vulner_lag_AI_biod, !is.na(vulner))

vulner_AI_biod_binmean <- binMean2D(vulner_lag_AI_biod1$AI, vulner_lag_AI_biod1$biod, vulner_lag_AI_biod1$vulner, xbreaks = seq(0,21000,1000), ybreaks = seq(0,3150,150), flatten=FALSE, fill=FALSE)

vulner_AI_biod_binmean_data <- as.data.frame(cbind(rep((vulner_AI_biod_binmean$xbreaks[1:21] + 500), 21), rep((vulner_AI_biod_binmean$ybreaks[1:21] + 75), each = 21), matrix(vulner_AI_biod_binmean$result, ncol = 1)))
names(vulner_AI_biod_binmean_data) <- c('AI','biod','vulner')
vulner_AI_biod_binmean_data$AI <- vulner_AI_biod_binmean_data$AI/10000

lag_AI_biod_binmean <- binMean2D(vulner_lag_AI_biod1$AI, vulner_lag_AI_biod1$biod, vulner_lag_AI_biod1$lag, xbreaks = seq(0,21000,1000), ybreaks = seq(0,3150,150), flatten=FALSE, fill=FALSE)

lag_AI_biod_binmean_data <- as.data.frame(cbind(rep((lag_AI_biod_binmean$xbreaks[1:21] + 500), 21), rep((lag_AI_biod_binmean$ybreaks[1:21] + 75), each = 21), matrix(lag_AI_biod_binmean$result, ncol = 1)))
names(lag_AI_biod_binmean_data) <- c('AI','biod','lag')
lag_AI_biod_binmean_data$AI <- lag_AI_biod_binmean_data$AI/10000

#-------------------------------------------
vulner_AI_biod_bins <- ggplot(vulner_AI_biod_binmean_data) + geom_tile(aes(x = AI, y = biod, fill = vulner), alpha = 0.8) + 
  scale_fill_gradient2(low = '#0066cc', high = '#ff8000', mid = '#ffffcc', midpoint = 0.35, na.value = NA) +
  scale_x_continuous(limits = c(0,2), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0,3000), expand = c(0.01,0.01)) +
  labs(fill = "Coincidence Rate") +
  theme_bw() +
  theme(axis.title = element_blank(), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(1, 'cm'), legend.key.width = unit(0.5,'cm'), legend.text = element_text(size = 20), legend.title = element_text(color = 'black', size = 20, angle = 90)) + 
  guides(color = guide_legend(title.position = "right"))

vulner_AI_biod_line <- as.data.frame(cbind(seq(0.05, 2.05, 0.1), apply(vulner_AI_biod_binmean$result, FUN = mean, MARGIN = 1, na.rm = T), seq(75, 3150, 150), apply(vulner_AI_biod_binmean$result, FUN = mean, MARGIN = 2, na.rm = T)))
names(vulner_AI_biod_line) <- c('AI', 'vulner_AI', 'biod', 'vulner_biod')

vulner_AI_trend <- ggplot(vulner_AI_biod_line, aes(x=AI, y=vulner_AI)) +
  geom_point() +
  geom_smooth(method=lm, formula = y~x) +
  scale_x_continuous(limits = c(0,2), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0.2,0.4), expand = c(0.01,0.01), breaks = c(0.2,0.3,0.4)) +
  ylab('Coincidence Rate') +
  annotate("text", label = "***", x=0.2, y=0.25, size=8)+
  theme_bw() +
  theme(axis.title.x = element_text(colour = 'black', size = 20), axis.title.y = element_blank(), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(3, 'cm'), legend.key.width = unit(1,'cm'), legend.text = element_text(size = 20))

vulner_biod_trend <- ggplot(vulner_AI_biod_line, aes(x=biod, y=vulner_biod)) +
  geom_point() +
  geom_smooth(method=lm, formula = y~x) +
  annotate("text", label = "***", x=500, y=0.25, size=8, angle = 90)+
  labs(x = 'Biodiversity', y = 'Coincidence Rate') +
  coord_flip() +
  scale_x_continuous(limits = c(0,3000), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0.2,0.4), expand = c(0.01,0.01), breaks = c(0.2,0.3,0.4)) +
  theme_bw() +
  theme(axis.title.y = element_text(colour = 'black', size = 20), axis.title.x = element_blank(), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(3, 'cm'), legend.key.width = unit(1,'cm'), legend.text = element_text(size = 20))

p_AI_biod_vulner <- ggpubr::ggarrange(vulner_biod_trend, vulner_AI_biod_bins, NA, vulner_AI_trend, common.legend = T, legend = 'right', widths = c(0.5,1,NA,1), heights = c(1,0.4))

#-------------------------------------------
lag_AI_biod_bins <- ggplot(lag_AI_biod_binmean_data) + geom_tile(aes(x = AI, y = biod, fill = lag), alpha = 0.8) + 
  scale_fill_gradient2(high = '#0066cc', low = '#ff8000', mid = '#ffffcc', midpoint = 40, na.value = NA) +
  scale_x_continuous(limits = c(0,2), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0,3000), expand = c(0.01,0.01)) +
  theme_bw() +
  theme(axis.title = element_blank(), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(1, 'cm'), legend.key.width = unit(0.5,'cm'), legend.text = element_text(size = 20), legend.title = element_text(color = 'black', size = 20, angle = 90)) + 
  guides(color = guide_legend(title.position = "right"))

lag_AI_biod_line <- as.data.frame(cbind(seq(0.05, 2.05, 0.1), apply(lag_AI_biod_binmean$result, FUN = mean, MARGIN = 1, na.rm = T), seq(75, 3150, 150), apply(lag_AI_biod_binmean$result, FUN = mean, MARGIN = 2, na.rm = T)))
names(lag_AI_biod_line) <- c('AI', 'lag_AI', 'biod', 'lag_biod')

lag_AI_trend <- ggplot(lag_AI_biod_line, aes(x=AI, y=lag_AI)) +
  geom_point() +
  geom_smooth(method=lm, formula = y~x) +
  scale_x_continuous(limits = c(0,2), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0,60), expand = c(0.01,0.01), breaks = c(20,40,60)) +
  ylab('Coincidence Rate') +
  annotate("text", label = "***", x=0.2, y=10, size=8)+
  theme_bw() +
  theme(axis.title.x = element_text(colour = 'black', size = 20), axis.title.y = element_blank(), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(3, 'cm'), legend.key.width = unit(1,'cm'), legend.text = element_text(size = 20))

lag_biod_trend <- ggplot(lag_AI_biod_line, aes(x=biod, y=lag_biod)) +
  geom_point() +
  geom_smooth(method=lm, formula = y~x) +
  annotate("text", label = "***", x=500, y=10, size=8, angle = 90)+
  coord_flip() +
  scale_x_continuous(limits = c(0,3000), expand = c(0.01,0.01)) +
  scale_y_continuous(limits = c(0,60), expand = c(0.01,0.01), breaks = c(20,40,60)) +
  xlab('Biodiversity') +
  theme_bw() +
  theme(axis.title.y = element_text(colour = 'black', size = 20), axis.title.x = element_blank(), axis.text = element_text(colour = 'black', size = 20), axis.text.y = element_text(angle = 90)) + 
  theme(panel.background = element_blank(),
        panel.grid = element_blank(), axis.ticks=element_line(color = 'black', size = 1), axis.ticks.length = unit(0.15, "cm")) +
  theme(panel.border = element_rect(linetype = "solid", fill = NA, linewidth = 1)) +
  theme(legend.direction = 'vertical', legend.title = element_blank(), legend.spacing.x = unit(0,'cm'), legend.position = 'right',legend.key = element_rect(color="black"), legend.key.height = unit(3, 'cm'), legend.key.width = unit(1,'cm'), legend.text = element_text(size = 20))

p_AI_biod_lag <- ggpubr::ggarrange(lag_biod_trend, lag_AI_biod_bins, NA, lag_AI_trend, common.legend = T, legend = 'right', widths = c(0.5,1,NA,1), heights = c(1,0.4))

library(ggpubr)
p1 <- ggarrange(vulner_kNDVI, lag_kNDVI, vulner_SIF, lag_SIF, legend = 'right')
ggsave(plot = p1, filename = 'Data/vulner_lag_spatial.pdf', device = 'pdf', width = 14, height = 12, units = c('in'))

p2 <- ggarrange(vulner_line_lat, lag_line_lat, p_type_kNDVI_vulner_barplot, p_type_kNDVI_lag_barplot)
ggsave(filename = 'Data/vulner_lag_lat.pdf', plot = p2, device = 'pdf', width = 14, height = 8, units = c('in'))

p3 <- ggarrange(p_AI_biod_vulner, p_AI_biod_lag)
ggsave(filename = 'Data/vulner_AI_biod.pdf', plot = p3, device = 'pdf', width = 14, height = 6, units = c('in'))
